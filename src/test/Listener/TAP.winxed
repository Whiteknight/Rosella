namespace Rosella { namespace Test { namespace Listener
{
    // The TAP listener listens for test results, and passes them on to the
    // simple TAP output builder
    class TAP : Rosella.Test.Listener
    {
        var test_builder;

        function BUILD()
        {
            using Rosella.build;
            self.test_builder = build(class Rosella.Test.Builder);
        }

        function add_error(var test, var context, var error)
        {
            self.add_failure(test, context, error); // Same, as far as we care
        }

        function add_failure(var test, var context, var error)
        {
            string label = context.display_name();
            string todo = context.test_todo();
            if (todo != null)
                self.test_builder.todo(0, label, todo);
            else
                self.test_builder.ok(0, label);

            self.test_builder.diag(error);
            return self;
        }

        function end_test(var test, var context)
        {
            string label = context.display_name();
            string todo = context.test_todo();
            if (todo != null)
                self.test_builder.todo(1, label, todo);
            else
                self.test_builder.ok(1, label);
            return self;
        }

        function plan_tests(int num_tests)
        {
            self.test_builder.plan(num_tests);
        }
    }
}}}

