namespace Rosella { namespace Template { namespace Node
{
    class Eval : Rosella.Template.Node
    {
        var func;
        const string EVAL_BASE_NAME = "Template_Node_Eval";

        function Eval(var token)
        {
            self.Node(token);
            self.func = null;
        }

        function render(var context, var builder)
        {
            if (self.func == null) {
                string code = self.token.data();
                self.func = self.compile_func(code);
            }
            var func = self.func;
            var results;
            :(results [slurpy]) = func(builder, context);
            for (string result in results)
                push(builder, result);
        }

        function compile_func(string code)
        {
            string code_s = Rosella.String.sprintf("function __%s__EVAL[anon](var output, var context) { %s; }", EVAL_BASE_NAME, code);
            var winxed = compreg("winxed");
            return winxed.compile(code_s);
        }
    }
}}}
